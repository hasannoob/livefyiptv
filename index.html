<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Livefy IP TV</title>
<link rel="icon" href="https://i.ibb.co/3k5p1t4/live-icon.png">
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root {
    --bg: #000; --card: #121212; --accent: #00E5FF; --fav: #FFD700; --text: #fff;
    --text-secondary: #aaa; --border-color: #2a2a2a;
}
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

/* অ্যাপ হেডার (উপরে থাকবে) */
.app-header {
    background: linear-gradient(180deg, #121212 0%, #000 100%);
    padding: 6px;
    text-align: center;
    border-bottom: 1px solid var(--border-color);
}
.app-header h1 {
    font-size: 1.4rem;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 0 0 10px rgba(0, 229, 255, 0.5);
    animation: glow 2s ease-in-out infinite alternate;
}

@keyframes glow {
    from { text-shadow: 0 0 5px rgba(0, 229, 255, 0.4); }
    to { text-shadow: 0 0 20px rgba(0, 229, 255, 0.8); }
}

.player-wrap { position: relative; width: 100%; background: #000; aspect-ratio: 16/9; flex-shrink: 0; }
.plyr { height: 100%; width: 100%; }

/* প্লেয়ারের নিচে চ্যানেলের নাম দেখানোর জায়গা */
.now-playing {
    background: #0a0a0a;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 10px;
}
.now-playing i { color: var(--accent); font-size: 0.8rem; }
#current-ch-name {
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.animate-name { animation: slideIn 0.5s ease-out; }
@keyframes slideIn {
    0% { opacity: 0; transform: translateX(-10px); }
    100% { opacity: 1; transform: translateX(0); }
}

#loader { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); z-index: 200; text-align: center; }
.spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.content-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.controls-panel { padding: 12px 15px; background: #0a0a0a; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px;}
.controls-panel select { width: 100%; padding: 10px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--text); font-size: 0.95rem; }

.actions { display: flex; background: #000; border-bottom: 1px solid var(--border-color); }
.actions div { flex: 1; text-align: center; padding: 12px 5px; font-size: 0.9rem; color: var(--text-secondary); cursor: pointer; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; }
.actions div.active-tab { color: var(--accent); font-weight: bold; border-bottom-color: var(--accent); }
.actions div .fa-telegram { margin-right: 6px; color: #2AABEE; }
.actions div .fa-sync-alt { margin-right: 6px; color: #FFC107; }

.search-container { padding: 10px 15px; background: #0a0a0a; }
#searchInput { width: 100%; padding: 12px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--text); font-size: 0.95rem; }
#searchInput::placeholder { color: #888; }

.list { flex: 1; overflow-y: auto; padding: 10px; padding-bottom: calc(70px + env(safe-area-inset-bottom)); background: var(--bg); scroll-behavior: smooth; }
.category-title { font-size: 1.1rem; font-weight: bold; color: var(--accent); padding: 15px 5px 8px 5px; border-bottom: 1px solid var(--border-color); margin-bottom: 10px; text-transform: uppercase; position: sticky; top: -10px; background: var(--bg); z-index: 10; }
.row { display: flex; align-items: center; gap: 12px; background: var(--card); padding: 10px; border-radius: 10px; margin-bottom: 8px; border-left: 3px solid transparent; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
.row:hover { background-color: #1f1f1f; }
.row.active { border-left-color: var(--accent); background: rgba(0, 229, 255, 0.05); }
.list-logo { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; }
.name { flex: 1; font-size: 0.95rem; color: #fff; font-weight: 500; }
.star-btn { font-size: 1.2rem; color: #555; cursor: pointer; padding: 5px; }
.star-btn.is-fav { color: var(--fav); }
</style>
</head>
<body>

<!-- অ্যাপের নাম উপরে -->
<div class="app-header">
    <h1>LIVEFY IP TV</h1>
</div>

<div class="player-wrap">
    <div id="loader">
        <div><div class="spinner"></div><div id="loader-text">Loading...</div></div>
    </div>
    <video id="video" playsinline crossorigin="anonymous"></video>
</div>

<!-- প্লেয়ারের নিচে চ্যানেলের নাম -->
<div class="now-playing">
    <i class="fas fa-circle-notch fa-spin"></i>
    <span id="current-ch-name">চ্যানেল নির্বাচন করুন</span>
</div>

<div class="content-area">
    <div class="controls-panel">
        <select id="categorySelect"></select>
    </div>
    <div class="actions">
        <div id="allBtnTab" class="active-tab" onclick="switchTab('all', this)"><i class="fas fa-list"></i> All Channels</div>
        <div id="favBtnTab" onclick="switchTab('fav', this)"><i class="fas fa-star"></i> Favorites</div>
        <div onclick="refreshCurrentStream()"><i class="fas fa-sync-alt"></i> Refresh</div>
        <div onclick="window.open('https://t.me/livefytv', '_blank')"><i class="fab fa-telegram"></i> Join Telegram</div>
    </div>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="চ্যানেল খুঁজুন..." onkeyup="render()">
    </div>
    <div class="list" id="list"></div>
</div>

<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
<script>
const video = document.getElementById('video');
const loader = document.getElementById('loader'), loaderText = document.getElementById('loader-text');
const listArea = document.getElementById('list'), searchInput = document.getElementById('searchInput');
const categorySelect = document.getElementById('categorySelect');
const chNameDisplay = document.getElementById('current-ch-name');

let hls = new Hls();
let player;
let categorizedChannels = {};
let currentChannel = null;
let isFavView = false;

const playlists = [
    { url: "https://raw.githubusercontent.com/sm-monirulislam/RoarZone-Auto-Update-playlist/refs/heads/main/RoarZone.m3u" },
    { url: "https://raw.githubusercontent.com/sm-monirulislam/SM-Live-TV/refs/heads/main/Bangla%20Channel.m3u" },    
];

document.addEventListener('DOMContentLoaded', () => {
    // Quality Settings Enabled
    player = new Plyr(video, { 
        controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'], 
        settings: ['quality', 'speed'] 
    });
    categorySelect.addEventListener('change', render);
    loadAllPlaylists();
    loadAdAfterInteraction(); 
});

async function loadAllPlaylists() {
    loader.style.display = 'flex';
    loaderText.innerText = 'Loading All Channels...';
    categorizedChannels = {};

    try {
        const fetchPromises = playlists.map(p => fetch(p.url).then(res => res.text()));
        const allPlaylistData = await Promise.all(fetchPromises);
        allPlaylistData.forEach(playlistText => parseM3U(playlistText));
        populateCategoryDropdown();
        render();
        loader.style.display = 'none';
        const firstCategory = Object.keys(categorizedChannels).sort()[0];
        if (firstCategory && categorizedChannels[firstCategory][0]) {
            handleChannelClick(categorizedChannels[firstCategory][0], true);
        }
    } catch (error) {
        console.error("Error loading playlists:", error);
        loaderText.innerText = `Failed to load channels.`;
    }
}

function parseM3U(data) {
    let lines = data.split('\n'), currentChannelInfo = null;
    for (const line of lines) {
        const trimmedLine = line.trim();
        if (trimmedLine.startsWith('#EXTINF')) {
            if (currentChannelInfo) addChannelToCategory(currentChannelInfo);
            const name = trimmedLine.split(',')[1]?.trim() || 'Unknown';
            const logo = trimmedLine.match(/tvg-logo="([^"]*)"/)?.[1] || null;
            const category = trimmedLine.match(/group-title="([^"]*)"/)?.[1]?.trim() || 'Uncategorized';
            currentChannelInfo = { name, logo, category, urls: [] };
        } else if (trimmedLine.startsWith('http') && currentChannelInfo) {
            currentChannelInfo.urls.push(trimmedLine);
        }
    }
    if (currentChannelInfo) addChannelToCategory(currentChannelInfo);
}

function addChannelToCategory(channelInfo) {
    if (!channelInfo || channelInfo.urls.length === 0) return;
    if (!categorizedChannels[channelInfo.category]) categorizedChannels[channelInfo.category] = [];
    categorizedChannels[channelInfo.category].push(channelInfo);
}

function populateCategoryDropdown() {
    categorySelect.innerHTML = '';
    categorySelect.appendChild(new Option('All Categories', '_all_'));
    Object.keys(categorizedChannels).sort().forEach(cat => {
        categorySelect.appendChild(new Option(cat, cat));
    });
}

function render() {
    listArea.innerHTML = "";
    const query = searchInput.value.toLowerCase();
    const selectedCategory = categorySelect.value;
    const sourceData = isFavView ? getFavoritesByCategory() : categorizedChannels;
    const categoriesToRender = (selectedCategory === '_all_') ? Object.keys(sourceData).sort() : [selectedCategory];

    for (const category of categoriesToRender) {
        if (!sourceData[category]) continue;
        const channels = sourceData[category];
        const filteredChannels = query ? channels.filter(ch => ch.name.toLowerCase().includes(query)) : channels;
        
        if (filteredChannels.length > 0) {
            if (selectedCategory === '_all_') {
                listArea.insertAdjacentHTML('beforeend', `<div class="category-title">${category}</div>`);
            }
            filteredChannels.forEach(ch => {
                const isFav = JSON.parse(localStorage.getItem('my_iptv_favs') || "[]").some(f => f.name === ch.name && f.urls[0] === ch.urls[0]);
                const isActive = currentChannel && currentChannel.name === ch.name;
                const row = document.createElement('div');
                row.className = `row ${isActive ? 'active' : ''}`;
                row.innerHTML = `<img src="${ch.logo}" class="list-logo" onerror="this.src='https://i.imgur.com/8Qf6Y0L.png'"><div class="name">${ch.name}</div><i class="fas fa-star star-btn ${isFav ? 'is-fav' : ''}"></i>`;
                row.querySelector('.star-btn').onclick = (e) => { e.stopPropagation(); toggleFav(ch); };
                row.onclick = () => handleChannelClick(ch, false);
                listArea.appendChild(row);
            });
        }
    }
}

function handleChannelClick(channel, isFirstLoad) {
    currentChannel = channel;
    
    // চ্যানেলের নাম আপডেট এবং অ্যানিমেশন
    chNameDisplay.innerText = channel.name;
    chNameDisplay.classList.remove('animate-name');
    void chNameDisplay.offsetWidth; // Trigger reflow
    chNameDisplay.classList.add('animate-name');

    playStream(channel.urls[0], isFirstLoad);
}

// Manual Quality Control Logic
function playStream(url, isFirstLoad = false) {
    loader.style.display = 'flex';
    loaderText.innerText = `Loading ${currentChannel.name}...`;
    try {
        if (Hls.isSupported()) {
            hls.destroy(); 
            hls = new Hls(); 
            hls.loadSource(url); 
            hls.attachMedia(video);
            
            hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                const availableQualities = hls.levels.map((l) => l.height);
                availableQualities.unshift(0); // Add 'Auto'

                player.quality = {
                    default: 0,
                    options: availableQualities,
                    forced: true,
                    onChange: (newQual) => {
                        if (newQual === 0) hls.currentLevel = -1;
                        else {
                            hls.levels.forEach((level, index) => {
                                if (level.height === newQual) hls.currentLevel = index;
                            });
                        }
                    },
                };

                player.muted = isFirstLoad; 
                player.play().catch(e => console.warn("Autoplay prevented.", e));
                loader.style.display = 'none';
            });
            hls.on(Hls.Events.ERROR, (e, data) => { if (data.fatal) throw new Error(`HLS Error: ${data.details}`); });
        } else { 
            video.src = url;
            player.muted = isFirstLoad;
            player.play().catch(e => console.warn("Autoplay prevented.", e));
            loader.style.display = 'none';
        }
    } catch (error) { 
        console.error("Stream Error:", error); 
        loaderText.innerText = 'Error loading stream.'; 
    }
    render();
}

function refreshCurrentStream() {
    if (currentChannel) playStream(currentChannel.urls[0], false);
}

function switchTab(type, el) {
    document.querySelectorAll('.actions div').forEach(d => d.classList.remove('active-tab'));
    el.classList.add('active-tab');
    isFavView = (type === 'fav');
    populateCategoryDropdown();
    render();
}

function toggleFav(ch) {
    let favs = JSON.parse(localStorage.getItem('my_iptv_favs') || "[]");
    const index = favs.findIndex(f => f.name === ch.name && f.urls[0] === ch.urls[0]);
    if (index > -1) favs.splice(index, 1); else favs.push(ch);
    localStorage.setItem('my_iptv_favs', JSON.stringify(favs));
    render();
}

function getFavoritesByCategory() {
    const favs = JSON.parse(localStorage.getItem('my_iptv_favs') || "[]");
    const favsByCategory = {};
    favs.forEach(ch => {
        const category = ch.category || 'Favorites';
        if (!favsByCategory[category]) favsByCategory[category] = [];
        favsByCategory[category].push(ch);
    });
    return favsByCategory;
}

function loadAdAfterInteraction() {
    let adLoaded = false;
    const adLoader = () => {
        if (adLoaded) return;
        adLoaded = true;
        setTimeout(() => {
            const adScript = document.createElement('script');
            adScript.type = 'text/javascript';
            adScript.src = 'https://pl28174272.effectivegatecpm.com/27/3c/04/273c0474fe4cdaf52aeda7349b12567a.js';
            document.body.appendChild(adScript);
        }, 5000); 
        document.removeEventListener('click', adLoader);
        document.removeEventListener('scroll', adLoader);
    };
    document.addEventListener('click', adLoader);
    document.addEventListener('scroll', adLoader);
}
</script>

</body>
</html>
