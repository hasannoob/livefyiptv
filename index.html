<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livefy TV (All Format Player)</title>

    <!-- Shaka Player CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.4/themes/dark.css">
    
    <!-- অন্যান্য লাইব্রেরি -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>

    <!-- Shaka Player JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.4/shaka-player.ui.js"></script>

<style>
/* আপনার পূর্ববর্তী সকল CSS কোড এখানে অপরিবর্তিত আছে */
body { font-family: 'Arial', sans-serif; background-color: black; color: #fff; margin: 0; padding: 0; padding-bottom: 70px; overflow-x: hidden; }
.main-header { background-color: #C80815; color: white; padding: 15px 10px; text-align: center; font-size: 28px; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); margin-bottom: 0; }
/* ... (বাকি সব CSS অপরিবর্তিত) ... */

/* ভিডিও প্লেয়ার সেকশনের জন্য নতুন এবং পরিবর্তিত CSS */
#video-player { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #080808; z-index: 1000; justify-content: center; align-items: center; flex-direction: column; padding: 10px; box-sizing: border-box; }
#player-wrapper { position: relative; width: 100%; max-width: 900px; aspect-ratio: 16/9; background-color: #000; border-radius: 15px; box-shadow: 0 0 25px rgba(0, 255, 0, 0.4); border: 4px solid #00ff00; overflow: hidden; }
#video-container, #iframe-container { width: 100%; height: 100%; }
#video { width: 100%; height: 100%; }
#embed-iframe { width: 100%; height: 100%; border: 0; }
#close-btn { position: absolute; top: 20px; right: 20px; font-size: 22px; color: white; background-color: #C80815; border: 3px solid #fff; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1011; transition: all 0.3s; }
#controls-area { width: 100%; max-width: 900px; margin-top: 20px; padding: 10px; background-color: #1a1a1a; border-radius: 10px; }
/* ... (আপনার বাকি সব CSS অপরিবর্তিত) ... */
</style>
</head>
<body>

    <!-- আপনার HTML এর উপরের অংশ অপরিবর্তিত -->
    <header class="main-header"> LIVEFY TV </header>
    <!-- ... (বাকি HTML অপরিবর্তিত) ... -->
    <div class="content">
        <!-- Home, Highlights, etc. sections here -->
        <!-- ... -->
        <!-- Live TV Section (আপনার নতুন ডিজাইন সহ) -->
        <div id="sports-channels-section" class="hidden">
             <!-- ... (আপনার Live TV সেকশনের HTML) ... -->
        </div>
    </div>
    
    <!-- ============================================== -->
    <!-- ========= হাইব্রিড প্লেয়ারের জন্য আপডেট করা HTML ========= -->
    <!-- ============================================== -->
    <div id="video-player">
        <button id="close-btn" onclick="closeVideo()">❌</button>
        <div id="player-wrapper">
            <!-- Shaka Player এর জন্য কন্টেইনার -->
            <div id="video-container">
                <video id="video" poster="" controls autoplay playsinline></video>
            </div>
            <!-- iFrame এর জন্য কন্টেইনার (সাধারণত লুকানো থাকবে) -->
            <div id="iframe-container" style="display: none;">
                <iframe id="embed-iframe" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>
        </div>

        <div id="error-message-box" style="display: none;">
            <h3 id="error-title">Error</h3>
            <p id="error-text"></p>
        </div>

        <div id="controls-area">
            <div id="server-buttons"></div>
        </div>
    </div>

    <!-- Nav Bar and other elements -->
    <!-- ... -->
    
    <script>
    // --- গ্লোবাল ভ্যারিয়েবল ---
    let shakaPlayer = null;
    const videoContainer = document.getElementById('video-container');
    const videoElement = document.getElementById('video');
    const iframeContainer = document.getElementById('iframe-container');
    const iframeElement = document.getElementById('embed-iframe');
    // ... (আপনার অন্যান্য গ্লোবাল ভ্যারিয়েবল)

    // --- Shaka Player সম্পর্কিত ফাংশন ---
    async function initShakaPlayer() {
        if (!shaka.Player.isBrowserSupported()) {
            console.error('Browser does not support Shaka Player!');
            return;
        }
        if (!shakaPlayer) {
            shakaPlayer = new shaka.Player(videoElement);
            const ui = new shaka.ui.Overlay(shakaPlayer, videoContainer, videoElement);
            ui.getControls();
            shakaPlayer.addEventListener('error', onPlayerError);
        }
    }

    function onPlayerError(event) {
        console.error('Shaka Player Error:', event.detail);
        showMessage("Playback Error", `The content could not be played. (Code: ${event.detail.code}). Please try another server.`);
    }

    async function playShaka(url) {
        iframeContainer.style.display = 'none';
        videoContainer.style.display = 'block';
        await initShakaPlayer();
        try {
            await shakaPlayer.load(url);
        } catch (error) {
            onPlayerError({ detail: error });
        }
    }

    // --- iFrame সম্পর্কিত ফাংশন ---
    function playIframe(url) {
        if (shakaPlayer) shakaPlayer.unload(); // Shaka প্লেয়ার লোড থাকলে আনলোড করুন
        videoContainer.style.display = 'none';
        iframeContainer.style.display = 'block';
        iframeElement.src = url;
    }
    
    function playYouTube(url) {
        const videoId = getYouTubeID(url);
        if (videoId) {
            const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
            playIframe(embedUrl);
        } else {
            showMessage("Invalid URL", "Could not extract YouTube video ID.");
        }
    }

    function getYouTubeID(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // --- মূল কন্ট্রোল ফাংশন ---
    function playContent(channelUrl) {
        hideMessage();
        if (typeof channelUrl !== 'string') return;

        // লিঙ্কের ধরণ সনাক্ত করা
        if (channelUrl.includes('youtube.com') || channelUrl.includes('youtu.be')) {
            playYouTube(channelUrl);
        } else if (channelUrl.endsWith('.m3u8') || channelUrl.endsWith('.mpd')) {
            playShaka(channelUrl);
        } else {
            // অন্য যেকোনো লিঙ্কের জন্য সাধারণ iFrame
            playIframe(channelUrl);
        }
    }

    function openMatchChannels(channelsData) {
        document.getElementById('video-player').style.display = 'flex';
        serverButtonsContainer.innerHTML = '';
        hideMessage();
        if (!channelsData || channelsData.length === 0) {
            showMessage("Error", "No channels found.");
            return;
        }
        channelsData.forEach((channel) => {
            const button = document.createElement('button');
            button.className = 'server-button';
            button.textContent = channel.name;
            button.onclick = () => selectServer(channel.url, button);
            serverButtonsContainer.appendChild(button);
        });
        const firstButton = serverButtonsContainer.querySelector('.server-button');
        if (firstButton) {
            selectServer(channelsData[0].url, firstButton);
        }
    }

    function selectServer(serverSrc, clickedButton) {
        document.querySelectorAll('.server-button').forEach(btn => btn.classList.remove('active-server'));
        if (clickedButton) clickedButton.classList.add('active-server');
        playContent(serverSrc);
    }

    async function closeVideo() {
        document.getElementById('video-player').style.display = 'none';
        // উভয় প্লেয়ারকে বন্ধ করা
        if (shakaPlayer) {
            await shakaPlayer.unload();
        }
        iframeElement.src = 'about:blank';
        serverButtonsContainer.innerHTML = '';
    }

    function showMessage(title, message) {
        const errorTitle = document.getElementById('error-title');
        const errorText = document.getElementById('error-text');
        if (errorTitle && errorText) {
            errorTitle.textContent = title;
            errorText.textContent = message;
            errorMessageBox.style.display = 'block';
        }
    }

    function hideMessage() {
        if (errorMessageBox) errorMessageBox.style.display = 'none';
    }

    // --- আপনার বাকি সব JavaScript ফাংশন (updateClock, checkMatchStatus, ইত্যাদি) অপরিবর্তিত থাকবে ---
    // ...
    
    document.addEventListener('DOMContentLoaded', () => {
        // Shaka Player এর জন্য প্রয়োজনীয় polyfill লোড করা
        shaka.polyfill.installAll();
        // ... আপনার বাকি DOMContentLoaded এর কোড
    });
    </script>

</body>
</html>
