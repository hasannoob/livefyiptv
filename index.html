<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Livefy IP TV - News & Ads</title>
<link rel="icon" href="https://i.ibb.co/3k5p1t4/live-icon.png">
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root {
    --bg: #000; --card: #121212; --accent: #00E5FF; --fav: #FFD700; --text: #fff;
    --text-secondary: #aaa; --border-color: #2a2a2a;
}
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

.app-header {
    background: linear-gradient(180deg, #121212 0%, #000 100%);
    padding: 5px; 
    text-align: center;
    border-bottom: 1px solid var(--border-color);
}
.app-header h1 {
    font-size: 1.1rem;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 1.5px;
}

/* --- নিউজ টিকার স্টাইল --- */
.news-ticker-container {
    background: #1a1a1a;
    height: 35px;
    overflow: hidden;
    display: flex;
    align-items: center;
    z-index: 100;
    border-bottom: 2px solid #ed1c24;
}
.news-label {
    background: #ed1c24;
    color: white;
    padding: 0 12px;
    font-size: 0.8rem;
    font-weight: bold;
    height: 100%;
    display: flex;
    align-items: center;
    z-index: 10;
    white-space: nowrap;
}
.ticker-wrap {
    flex: 1;
    overflow: hidden;
    height: 100%;
    display: flex;
    align-items: center;
}
.ticker-content {
    display: inline-block;
    white-space: nowrap;
    padding-left: 100%;
    animation: ticker-animation 130s linear infinite; /* পড়ার জন্য স্লো স্পিড */
    font-size: 0.95rem;
    color: #fff;
}
.ticker-content:hover { animation-play-state: paused; } /* টাচ করলে নিউজ থেমে যাবে */
.news-item { margin-right: 100px; display: inline-block; }
.news-icon { color: #ed1c24; margin-right: 8px; }

@keyframes ticker-animation {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100%); }
}

.player-wrap { position: relative; width: 100%; background: #000; aspect-ratio: 16/9; flex-shrink: 0; }
.plyr { height: 100%; width: 100%; }

.now-playing {
    background: #0a0a0a;
    padding: 8px 15px; 
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 8px;
}
.now-playing i { color: var(--accent); font-size: 0.7rem; }
#current-ch-name { font-size: 0.9rem; font-weight: 600; }

#loader { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); z-index: 200; }
.spinner { width: 30px; height: 30px; border: 3px solid #333; border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.content-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.controls-panel { padding: 6px 12px; background: #0a0a0a; border-bottom: 1px solid var(--border-color); }
.controls-panel select { width: 100%; padding: 8px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: var(--text); outline: none;}

.actions { display: flex; background: #000; border-bottom: 1px solid var(--border-color); }
.actions div { flex: 1; text-align: center; padding: 10px 2px; font-size: 0.75rem; color: var(--text-secondary); cursor: pointer; }
.actions div.active-tab { color: var(--accent); border-bottom: 2px solid var(--accent); font-weight: bold; }

.search-container { padding: 8px 12px; background: #0a0a0a; }
#searchInput { width: 100%; padding: 10px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: var(--text); outline: none;}

.list { flex: 1; overflow-y: auto; padding: 8px; background: var(--bg); }
.category-title { font-size: 0.85rem; font-weight: bold; color: var(--accent); padding: 10px 5px; border-bottom: 1px solid var(--border-color); margin-bottom: 8px; text-transform: uppercase; position: sticky; top: -1px; background: var(--bg); z-index: 10; }
.row { display: flex; align-items: center; gap: 12px; background: var(--card); padding: 10px; border-radius: 8px; margin-bottom: 6px; border-left: 3px solid transparent; cursor: pointer; }
.row.active { border-left-color: var(--accent); background: rgba(0, 229, 255, 0.08); }
.list-logo { width: 45px; height: 45px; border-radius: 6px; object-fit: cover; }
.name { flex: 1; font-size: 0.9rem; color: #fff; }
</style>
</head>
<body>

<div class="app-header">
    <h1>LIVEFY IP TV</h1>
</div>

<div class="news-ticker-container">
    <div class="news-label">ব্রেকিং নিউজ</div>
    <div class="ticker-wrap">
        <div class="ticker-content" id="news-ticker-text">
            প্রথম আলো (বাংলা এডিশন) থেকে সর্বশেষ সংবাদ লোড হচ্ছে...
        </div>
    </div>
</div>

<div class="player-wrap">
    <div id="loader">
        <div class="spinner"></div>
    </div>
    <video id="video" playsinline crossorigin="anonymous"></video>
</div>

<div class="now-playing">
    <i class="fas fa-circle-notch fa-spin"></i>
    <span id="current-ch-name">চ্যানেল নির্বাচন করুন</span>
</div>

<div class="content-area">
    <div class="controls-panel">
        <select id="categorySelect"></select>
    </div>
    <div class="actions">
        <div id="allBtnTab" class="active-tab" onclick="switchTab('all', this)"><i class="fas fa-list"></i> All</div>
        <div id="favBtnTab" onclick="switchTab('fav', this)"><i class="fas fa-star"></i> Favorites</div>
        <div onclick="refreshCurrentStream()"><i class="fas fa-sync-alt"></i> Refresh</div>
        <div onclick="window.open('https://t.me/livefytv', '_blank')"><i class="fab fa-telegram"></i> Telegram</div>
    </div>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="চ্যানেল খুঁজুন..." onkeyup="render()">
    </div>
    <div class="list" id="list"></div>
</div>

<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
<script>
const video = document.getElementById('video');
const loader = document.getElementById('loader');
const listArea = document.getElementById('list'), searchInput = document.getElementById('searchInput');
const categorySelect = document.getElementById('categorySelect');
const chNameDisplay = document.getElementById('current-ch-name');

let hls = new Hls();
let player;
let categorizedChannels = {};
let currentChannel = null;
let isFavView = false;

const playlists = [
    { url: "https://raw.githubusercontent.com/sm-monirulislam/RoarZone-Auto-Update-playlist/refs/heads/main/RoarZone.m3u" },
    { url: "https://raw.githubusercontent.com/sm-monirulislam/SM-Live-TV/refs/heads/main/Bangla%20Channel.m3u" },    
];

document.addEventListener('DOMContentLoaded', () => {
    player = new Plyr(video, { 
        controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen']
    });
    loadAllPlaylists();
    fetchBanglaNews(); 
    loadAdAfterInteraction(); // এইখানে আপনার অ্যাড কল করা হয়েছে
});

// --- আপনার Adsterra অ্যাড ফাংশন (যথাযথভাবে আছে) ---
function loadAdAfterInteraction() {
    let adLoaded = false;
    const adLoader = () => {
        if (adLoaded) return;
        adLoaded = true;
        setTimeout(() => {
            const adScript = document.createElement('script');
            adScript.type = 'text/javascript';
            adScript.src = 'https://pl28174272.effectivegatecpm.com/27/3c/04/273c0474fe4cdaf52aeda7349b12567a.js';
            document.body.appendChild(adScript);
        }, 5000); 
        document.removeEventListener('click', adLoader);
        document.removeEventListener('scroll', adLoader);
    };
    document.addEventListener('click', adLoader);
    document.addEventListener('scroll', adLoader);
}

// --- প্রথম আলো বাংলা নিউজ ফাংশন ---
async function fetchBanglaNews() {
    const tickerText = document.getElementById('news-ticker-text');
    const rssUrl = "https://www.prothomalo.com/feed";
    const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;
    try {
        const response = await fetch(apiUrl);
        const data = await response.json();
        if (data.items && data.items.length > 0) {
            const headlines = data.items.map(item => `<i class="fas fa-star news-icon" style="font-size:8px;"></i> ${item.title}`).join(' &nbsp;&nbsp;&nbsp; | &nbsp;&nbsp;&nbsp; ');
            tickerText.innerHTML = `<span class="news-item">${headlines}</span><span class="news-item">${headlines}</span>`;
        }
    } catch (error) { tickerText.innerHTML = "সংবাদ লোড করা সম্ভব হচ্ছে না।"; }
}

async function loadAllPlaylists() {
    loader.style.display = 'flex';
    categorizedChannels = {};
    try {
        const fetchPromises = playlists.map(p => fetch(p.url).then(res => res.text()));
        const allPlaylistData = await Promise.all(fetchPromises);
        allPlaylistData.forEach(playlistText => parseM3U(playlistText));
        populateCategoryDropdown();
        render();
        loader.style.display = 'none';
        const keys = Object.keys(categorizedChannels).sort();
        if (keys[0] && categorizedChannels[keys[0]][0]) handleChannelClick(categorizedChannels[keys[0]][0], true);
    } catch (error) { loader.style.display = 'none'; }
}

function parseM3U(data) {
    let lines = data.split('\n'), currentInfo = null;
    for (const line of lines) {
        const trm = line.trim();
        if (trm.startsWith('#EXTINF')) {
            const name = trm.split(',')[1]?.trim() || 'Unknown';
            const logo = trm.match(/tvg-logo="([^"]*)"/)?.[1] || "";
            const category = trm.match(/group-title="([^"]*)"/)?.[1]?.trim() || 'Uncategorized';
            currentInfo = { name, logo, category, urls: [] };
        } else if (trm.startsWith('http') && currentInfo) {
            currentInfo.urls.push(trm);
            if (!categorizedChannels[currentInfo.category]) categorizedChannels[currentInfo.category] = [];
            categorizedChannels[currentInfo.category].push(currentInfo);
            currentInfo = null;
        }
    }
}

function populateCategoryDropdown() {
    categorySelect.innerHTML = '<option value="_all_">All Categories</option>';
    Object.keys(categorizedChannels).sort().forEach(cat => {
        categorySelect.appendChild(new Option(cat, cat));
    });
    categorySelect.onchange = render;
}

function render() {
    listArea.innerHTML = "";
    const query = searchInput.value.toLowerCase();
    const selCat = categorySelect.value;
    const data = isFavView ? getFavoritesByCategory() : categorizedChannels;
    const cats = (selCat === '_all_') ? Object.keys(data).sort() : [selCat];

    cats.forEach(cat => {
        if (!data[cat]) return;
        const filtered = data[cat].filter(ch => ch.name.toLowerCase().includes(query));
        if (filtered.length > 0) {
            if (selCat === '_all_') listArea.insertAdjacentHTML('beforeend', `<div class="category-title">${cat}</div>`);
            filtered.forEach(ch => {
                const isFav = JSON.parse(localStorage.getItem('my_iptv_favs') || "[]").some(f => f.name === ch.name);
                const row = document.createElement('div');
                row.className = `row ${currentChannel?.name === ch.name ? 'active' : ''}`;
                row.innerHTML = `<img src="${ch.logo}" class="list-logo" onerror="this.src='https://i.imgur.com/8Qf6Y0L.png'"><div class="name">${ch.name}</div><i class="fas fa-star star-btn ${isFav ? 'is-fav' : ''}" onclick="event.stopPropagation(); toggleFav('${ch.name}')"></i>`;
                row.onclick = () => handleChannelClick(ch, false);
                listArea.appendChild(row);
            });
        }
    });
}

function handleChannelClick(ch, isFirst) {
    currentChannel = ch;
    chNameDisplay.innerText = ch.name;
    loader.style.display = 'flex';
    if (Hls.isSupported()) {
        hls.destroy(); hls = new Hls(); hls.loadSource(ch.urls[0]); hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => { loader.style.display = 'none'; player.muted = isFirst; player.play().catch(()=>{}); });
    } else { video.src = ch.urls[0]; loader.style.display = 'none'; }
    render();
}

function toggleFav(name) {
    let favs = JSON.parse(localStorage.getItem('my_iptv_favs') || "[]");
    const idx = favs.findIndex(f => f.name === name);
    if (idx > -1) favs.splice(idx, 1);
    else {
        for (let cat in categorizedChannels) {
            const found = categorizedChannels[cat].find(c => c.name === name);
            if (found) { favs.push(found); break; }
        }
    }
    localStorage.setItem('my_iptv_favs', JSON.stringify(favs));
    render();
}

function getFavoritesByCategory() {
    const favs = JSON.parse(localStorage.getItem('my_iptv_favs') || "[]");
    const obj = {};
    favs.forEach(ch => { 
        if (!obj[ch.category]) obj[ch.category] = [];
        obj[ch.category].push(ch);
    });
    return obj;
}

function switchTab(type, el) {
    document.querySelectorAll('.actions div').forEach(d => d.classList.remove('active-tab'));
    el.classList.add('active-tab');
    isFavView = (type === 'fav');
    render();
}

function refreshCurrentStream() { if (currentChannel) handleChannelClick(currentChannel, false); }
</script>

</body>
</html>
